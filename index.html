<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Financial Planning Whiteboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f8f9fa;
            overflow: hidden;
        }

        .toolbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 12px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            z-index: 1000;
            flex-wrap: wrap;
        }

        .tool-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255,255,255,0.15);
            padding: 8px 12px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .tool-btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid transparent;
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .tool-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-1px);
        }

        .tool-btn.active {
            background: rgba(255,255,255,0.9);
            color: #667eea;
            border-color: rgba(255,255,255,0.3);
        }

        .color-picker {
            width: 35px;
            height: 35px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-picker:hover {
            transform: scale(1.1);
            border-color: rgba(255,255,255,0.6);
        }

        .size-slider {
            width: 80px;
            height: 6px;
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
            outline: none;
            cursor: pointer;
        }

        .participants {
            background: rgba(255,255,255,0.15);
            padding: 8px 15px;
            border-radius: 20px;
            color: white;
            font-size: 14px;
            margin-left: auto;
        }

        .canvas-container {
            position: relative;
            width: 100vw;
            height: calc(100vh - 80px);
            overflow: hidden;
            background: white;
        }

        #whiteboard {
            cursor: crosshair;
            touch-action: none;
            background: 
                radial-gradient(circle at 20px 20px, #e0e0e0 1px, transparent 1px),
                radial-gradient(circle at 20px 20px, #e0e0e0 1px, transparent 1px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }

        .text-input {
            position: absolute;
            border: 2px dashed #667eea;
            background: rgba(255,255,255,0.95);
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 16px;
            min-width: 200px;
            min-height: 40px;
            resize: both;
            outline: none;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .cursor-indicator {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            pointer-events: none;
            transform: translate(-50%, -50%);
            z-index: 100;
            transition: opacity 0.3s ease;
        }

        .participant-label {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            transform: translate(-50%, -200%);
            white-space: nowrap;
        }

        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 1000;
        }

        .zoom-btn {
            width: 45px;
            height: 45px;
            background: rgba(255,255,255,0.95);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            color: #667eea;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s ease;
        }

        .zoom-btn:hover {
            background: white;
            transform: scale(1.1);
        }

        .grid-toggle {
            background: rgba(255,255,255,0.9);
            border: 2px solid #667eea;
            color: #667eea;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .grid-toggle:hover {
            background: #667eea;
            color: white;
        }

        .save-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 1001;
        }

        .save-indicator.show {
            opacity: 1;
        }

        .background-selector {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .background-selector.show {
            display: flex;
        }

        .background-grid {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .background-grid h2 {
            text-align: center;
            margin-bottom: 20px;
            color: #333;
            font-size: 24px;
        }

        .background-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }

        .background-header h2 {
            margin: 0;
            color: #333;
            font-size: 24px;
        }

        .background-apply-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
            min-width: 180px;
        }

        .background-apply-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .background-apply-btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .background-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .background-option {
            border: 3px solid #e0e0e0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .background-option:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }

        .background-option.selected {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .background-preview {
            width: 100%;
            height: 180px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 48px;
            color: #667eea;
        }

        .background-title {
            font-weight: bold;
            margin-bottom: 5px;
            color: #333;
        }

        .background-description {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .background-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 25px;
        }

        .background-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .background-btn.primary {
            background: #667eea;
            color: white;
        }

        .background-btn.primary:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .background-btn.secondary {
            background: #e0e0e0;
            color: #333;
        }

        .background-btn.secondary:hover {
            background: #d0d0d0;
        }

        body.presentation-mode {
            overflow: hidden;
        }

        body.presentation-mode .toolbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 2000;
            opacity: 0.7;
            transition: opacity 0.3s ease;
            flex-wrap: wrap;
            padding: 8px 12px;
        }

        body.presentation-mode .toolbar:hover {
            opacity: 1;
        }

        body.presentation-mode .canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            padding-top: 70px;
            background: white;
        }

        body.presentation-mode #whiteboard {
            width: 100vw !important;
            height: calc(100vh - 70px) !important;
        }

        body.presentation-mode .zoom-controls {
            z-index: 2001;
        }

        .presentation-exit-hint {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(102, 126, 234, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 2002;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        body.presentation-mode .presentation-exit-hint {
            opacity: 1;
        }

        body.presentation-mode .background-selector {
            z-index: 2500;
        }
    </style>
</head>
<body>
    <div class="toolbar">
        <div class="tool-group">
            <button class="tool-btn active" data-tool="pen">✏️ Pen</button>
            <button class="tool-btn" data-tool="eraser">🧽 Eraser</button>
            <button class="tool-btn" data-tool="text">📝 Text</button>
            <button class="tool-btn" data-tool="line">📏 Line</button>
            <button class="tool-btn" data-tool="rectangle">⬜ Rectangle</button>
            <button class="tool-btn" data-tool="circle">⭕ Circle</button>
        </div>

        <div class="tool-group">
            <input type="color" class="color-picker" value="#2563eb" id="colorPicker">
            <input type="range" class="size-slider" min="1" max="20" value="3" id="sizeSlider">
            <span style="color: white; font-size: 14px;" id="sizeDisplay">3px</span>
        </div>

        <div class="tool-group">
            <button class="tool-btn" onclick="showBackgrounds()">🖼️ Backgrounds</button>
            <button class="tool-btn" onclick="copyCanvas()">📋 Copy</button>
            <button class="tool-btn" onclick="clearCanvas()">🗑️ Clear</button>
            <button class="tool-btn" onclick="saveCanvas()">💾 Save</button>
            <button class="tool-btn" onclick="toggleGrid()">⊞ Grid</button>
        </div>

        <div class="participants">
            👥 <span id="participantCount">1</span> Active
        </div>
    </div>

    <div class="canvas-container">
        <canvas id="whiteboard"></canvas>
        <div class="save-indicator" id="saveIndicator">Whiteboard Saved!</div>
        
        <!-- Background Selector Modal -->
        <div class="background-selector" id="backgroundSelector">
            <div class="background-grid">
                <div class="background-header">
                    <h2>Choose a Financial Planning Background</h2>
                    <button class="background-apply-btn" id="applyBackgroundBtn" onclick="applyBackground()" disabled>
                        Apply Background
                    </button>
                </div>
                
                <div class="background-options">
                    <div class="background-option" data-bg="goals-based">
                        <div class="background-preview">📊</div>
                        <div class="background-title">Goals-Based Investing</div>
                        <div class="background-description">Risk/return matrix with timeline, investment categories, and goal examples</div>
                    </div>
                    
                    <div class="background-option" data-bg="portfolio-allocation">
                        <div class="background-preview">🥧</div>
                        <div class="background-title">Portfolio Allocation</div>
                        <div class="background-description">Pie chart template with asset classes and percentage breakdowns</div>
                    </div>
                    
                    <div class="background-option" data-bg="cash-flow">
                        <div class="background-preview">💰</div>
                        <div class="background-title">Cash Flow Analysis</div>
                        <div class="background-description">Income vs expenses chart with monthly/yearly tracking</div>
                    </div>
                    
                    <div class="background-option" data-bg="retirement-timeline">
                        <div class="background-preview">🎯</div>
                        <div class="background-title">Retirement Planning</div>
                        <div class="background-description">Age-based timeline with savings milestones and withdrawal strategy</div>
                    </div>
                    
                    <div class="background-option" data-bg="debt-strategy">
                        <div class="background-preview">📉</div>
                        <div class="background-title">Debt Payoff Strategy</div>
                        <div class="background-description">Debt snowball/avalanche comparison with payment schedules</div>
                    </div>
                    
                    <div class="background-option" data-bg="emergency-fund">
                        <div class="background-preview">🛡️</div>
                        <div class="background-title">Emergency Fund Planning</div>
                        <div class="background-description">3-6 month expense calculator with savings progress tracker</div>
                    </div>
                    
                    <div class="background-option" data-bg="investment-comparison">
                        <div class="background-preview">⚖️</div>
                        <div class="background-title">Investment Comparison</div>
                        <div class="background-description">Side-by-side analysis template for different investment options</div>
                    </div>
                    
                    <div class="background-option" data-bg="blank">
                        <div class="background-preview">📄</div>
                        <div class="background-title">Blank Canvas</div>
                        <div class="background-description">Clean slate for custom financial diagrams and notes</div>
                    </div>
                </div>
                
                <div class="background-actions">
                    <button class="background-btn secondary" onclick="hideBackgrounds()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomOut()">−</button>
        <button class="zoom-btn" onclick="resetZoom()" style="font-size: 16px;">⌂</button>
    </div>

    <script>
        class CollaborativeWhiteboard {
            constructor() {
                this.canvas = document.getElementById('whiteboard');
                this.ctx = this.canvas.getContext('2d');
                this.isDrawing = false;
                this.currentTool = 'pen';
                this.currentColor = '#2563eb';
                this.currentSize = 3;
                this.lastX = 0;
                this.lastY = 0;
                this.zoom = 1;
                this.panX = 0;
                this.panY = 0;
                this.showGrid = true;
                this.participants = new Map();
                this.textInputs = [];
                this.shapeStart = null;
                this.isShapeDrawing = false;
                this.selectedBackground = null;
                this.backgroundTemplates = this.initializeBackgrounds();
                this.savedImageData = null; // Store canvas state before preview
                
                this.setupCanvas();
                this.setupEventListeners();
                this.setupCollaboration();
                this.drawGrid();
                
                // Simulate some collaborative cursors for demo
                this.simulateCollaboration();
            }

            setupCanvas() {
                this.resizeCanvas();
                this.ctx.lineCap = 'round';
                this.ctx.lineJoin = 'round';
                window.addEventListener('resize', () => this.resizeCanvas());
            }

            resizeCanvas() {
                const container = this.canvas.parentElement;
                this.canvas.width = container.clientWidth;
                this.canvas.height = container.clientHeight;
                this.redraw();
            }

            setupEventListeners() {
                // Tool selection
                document.querySelectorAll('[data-tool]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelector('.tool-btn.active')?.classList.remove('active');
                        e.target.classList.add('active');
                        this.currentTool = e.target.dataset.tool;
                        this.canvas.style.cursor = this.getCursor();
                    });
                });

                // Color and size controls
                document.getElementById('colorPicker').addEventListener('change', (e) => {
                    this.currentColor = e.target.value;
                });

                const sizeSlider = document.getElementById('sizeSlider');
                sizeSlider.addEventListener('input', (e) => {
                    this.currentSize = e.target.value;
                    document.getElementById('sizeDisplay').textContent = e.target.value + 'px';
                });

                // Drawing events
                this.canvas.addEventListener('mousedown', (e) => this.startDrawing(e));
                this.canvas.addEventListener('mousemove', (e) => this.draw(e));
                this.canvas.addEventListener('mouseup', () => this.stopDrawing());
                this.canvas.addEventListener('mouseout', () => this.stopDrawing());

                // Touch events for tablets/stylus
                this.canvas.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousedown', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                });

                this.canvas.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousemove', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    this.canvas.dispatchEvent(mouseEvent);
                });

                this.canvas.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    const mouseEvent = new MouseEvent('mouseup', {});
                    this.canvas.dispatchEvent(mouseEvent);
                });

                // Keyboard shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch(e.key) {
                            case 'z':
                                e.preventDefault();
                                this.undo();
                                break;
                            case 's':
                                e.preventDefault();
                                this.save();
                                break;
                            case 'c':
                                e.preventDefault();
                                this.copyToClipboard();
                                break;
                        }
                    }
                });

                // Mouse tracking for collaboration
                this.canvas.addEventListener('mousemove', (e) => {
                    this.updateCursor(e);
                });
            }

            getCursor() {
                switch(this.currentTool) {
                    case 'pen': return 'crosshair';
                    case 'eraser': return 'grab';
                    case 'text': return 'text';
                    default: return 'crosshair';
                }
            }

            getMousePos(e) {
                const rect = this.canvas.getBoundingClientRect();
                return {
                    x: (e.clientX - rect.left - this.panX) / this.zoom,
                    y: (e.clientY - rect.top - this.panY) / this.zoom
                };
            }

            startDrawing(e) {
                const pos = this.getMousePos(e);
                this.isDrawing = true;
                this.lastX = pos.x;
                this.lastY = pos.y;

                if (this.currentTool === 'text') {
                    this.createTextInput(pos.x, pos.y);
                    return;
                }

                if (['line', 'rectangle', 'circle'].includes(this.currentTool)) {
                    this.shapeStart = pos;
                    this.isShapeDrawing = true;
                    // Save current canvas state before starting shape preview
                    this.savedImageData = this.ctx.getImageData(0, 0, this.canvas.width, this.canvas.height);
                    return;
                }

                this.ctx.beginPath();
                this.ctx.moveTo(pos.x, pos.y);
                
                // Save state for undo
                this.saveState();
            }

            draw(e) {
                if (!this.isDrawing) return;

                const pos = this.getMousePos(e);
                
                this.ctx.save();
                this.ctx.scale(this.zoom, this.zoom);
                this.ctx.translate(this.panX / this.zoom, this.panY / this.zoom);

                if (this.isShapeDrawing) {
                    this.drawShapePreview(pos);
                    return;
                }

                this.ctx.globalCompositeOperation = this.currentTool === 'eraser' ? 'destination-out' : 'source-over';
                this.ctx.strokeStyle = this.currentColor;
                this.ctx.lineWidth = this.currentSize;

                this.ctx.beginPath();
                this.ctx.moveTo(this.lastX, this.lastY);
                this.ctx.lineTo(pos.x, pos.y);
                this.ctx.stroke();

                this.lastX = pos.x;
                this.lastY = pos.y;
                
                this.ctx.restore();
            }

            stopDrawing() {
                if (!this.isDrawing) return;
                
                if (this.isShapeDrawing) {
                    this.finalizeShape();
                    this.isShapeDrawing = false;
                    this.shapeStart = null;
                    this.savedImageData = null; // Clear saved state
                }
                
                this.isDrawing = false;
                this.ctx.beginPath();
            }

            drawShapePreview(currentPos) {
                // Restore saved canvas state before drawing preview
                if (this.savedImageData) {
                    this.ctx.putImageData(this.savedImageData, 0, 0);
                }
                
                this.ctx.save();
                this.ctx.scale(this.zoom, this.zoom);
                this.ctx.translate(this.panX / this.zoom, this.panY / this.zoom);
                
                this.ctx.strokeStyle = this.currentColor;
                this.ctx.lineWidth = this.currentSize;
                this.ctx.setLineDash([5, 5]);
                
                this.ctx.beginPath();
                
                switch(this.currentTool) {
                    case 'line':
                        this.ctx.moveTo(this.shapeStart.x, this.shapeStart.y);
                        this.ctx.lineTo(currentPos.x, currentPos.y);
                        break;
                    case 'rectangle':
                        const width = currentPos.x - this.shapeStart.x;
                        const height = currentPos.y - this.shapeStart.y;
                        this.ctx.rect(this.shapeStart.x, this.shapeStart.y, width, height);
                        break;
                    case 'circle':
                        const radius = Math.sqrt(
                            Math.pow(currentPos.x - this.shapeStart.x, 2) + 
                            Math.pow(currentPos.y - this.shapeStart.y, 2)
                        );
                        this.ctx.arc(this.shapeStart.x, this.shapeStart.y, radius, 0, 2 * Math.PI);
                        break;
                }
                
                this.ctx.stroke();
                this.ctx.restore();
            }

            finalizeShape() {
                // Restore the saved state first (removes preview)
                if (this.savedImageData) {
                    this.ctx.putImageData(this.savedImageData, 0, 0);
                }
                
                const currentPos = this.getMousePos(event);
                
                this.ctx.save();
                this.ctx.scale(this.zoom, this.zoom);
                this.ctx.translate(this.panX / this.zoom, this.panY / this.zoom);
                
                this.ctx.strokeStyle = this.currentColor;
                this.ctx.lineWidth = this.currentSize;
                this.ctx.setLineDash([]);
                
                this.ctx.beginPath();
                
                switch(this.currentTool) {
                    case 'line':
                        this.ctx.moveTo(this.shapeStart.x, this.shapeStart.y);
                        this.ctx.lineTo(currentPos.x, currentPos.y);
                        break;
                    case 'rectangle':
                        const width = currentPos.x - this.shapeStart.x;
                        const height = currentPos.y - this.shapeStart.y;
                        this.ctx.rect(this.shapeStart.x, this.shapeStart.y, width, height);
                        break;
                    case 'circle':
                        const radius = Math.sqrt(
                            Math.pow(currentPos.x - this.shapeStart.x, 2) + 
                            Math.pow(currentPos.y - this.shapeStart.y, 2)
                        );
                        this.ctx.arc(this.shapeStart.x, this.shapeStart.y, radius, 0, 2 * Math.PI);
                        break;
                }
                
                this.ctx.stroke();
                this.ctx.restore();
                
                this.saveState();
            }

            createTextInput(x, y) {
                const input = document.createElement('textarea');
                input.className = 'text-input';
                input.placeholder = 'Type your text here...';
                input.style.left = (x * this.zoom + this.panX) + 'px';
                input.style.top = (y * this.zoom + this.panY) + 'px';
                input.style.color = this.currentColor;
                input.style.fontSize = (this.currentSize * 4) + 'px';

                document.querySelector('.canvas-container').appendChild(input);
                input.focus();

                input.addEventListener('blur', () => {
                    if (input.value.trim()) {
                        this.renderText(input.value, x, y);
                    }
                    input.remove();
                });

                input.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        input.remove();
                    }
                });

                this.textInputs.push({input, x, y});
            }

            renderText(text, x, y) {
                this.ctx.save();
                this.ctx.scale(this.zoom, this.zoom);
                this.ctx.translate(this.panX / this.zoom, this.panY / this.zoom);
                
                this.ctx.fillStyle = this.currentColor;
                this.ctx.font = `${this.currentSize * 4}px Arial`;
                
                const lines = text.split('\n');
                lines.forEach((line, index) => {
                    this.ctx.fillText(line, x, y + (index * this.currentSize * 5));
                });
                
                this.ctx.restore();
                this.saveState();
            }

            drawGrid() {
                if (!this.showGrid) return;
                
                this.ctx.save();
                this.ctx.strokeStyle = '#e0e0e0';
                this.ctx.lineWidth = 0.5;
                
                const gridSize = 40 * this.zoom;
                const startX = (-this.panX % gridSize);
                const startY = (-this.panY % gridSize);
                
                this.ctx.beginPath();
                for (let x = startX; x < this.canvas.width; x += gridSize) {
                    this.ctx.moveTo(x, 0);
                    this.ctx.lineTo(x, this.canvas.height);
                }
                for (let y = startY; y < this.canvas.height; y += gridSize) {
                    this.ctx.moveTo(0, y);
                    this.ctx.lineTo(this.canvas.width, y);
                }
                this.ctx.stroke();
                this.ctx.restore();
            }

            redraw() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                // Draw background template if selected
                if (this.selectedBackground && this.backgroundTemplates[this.selectedBackground]) {
                    this.drawBackgroundTemplate(this.selectedBackground);
                } else if (this.showGrid) {
                    this.drawGrid();
                }
                
                // In a real implementation, you'd redraw saved strokes here
            }

            initializeBackgrounds() {
                return {
                    'goals-based': this.drawGoalsBasedTemplate,
                    'portfolio-allocation': this.drawPortfolioTemplate,
                    'cash-flow': this.drawCashFlowTemplate,
                    'retirement-timeline': this.drawRetirementTemplate,
                    'debt-strategy': this.drawDebtTemplate,
                    'emergency-fund': this.drawEmergencyTemplate,
                    'investment-comparison': this.drawComparisonTemplate,
                    'blank': null
                };
            }

            drawBackgroundTemplate(templateName) {
                if (!this.backgroundTemplates[templateName]) return;
                
                this.ctx.save();
                this.ctx.scale(this.zoom, this.zoom);
                this.ctx.translate(this.panX / this.zoom, this.panY / this.zoom);
                
                this.backgroundTemplates[templateName].call(this);
                
                this.ctx.restore();
            }

            drawGoalsBasedTemplate() {
                const w = this.canvas.width / this.zoom;
                const h = this.canvas.height / this.zoom;
                
                // Title
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 32px Arial';
                this.ctx.fillText('GOALS-BASED INVESTING', 50, 60);
                
                this.ctx.font = '18px Arial';
                this.ctx.fillStyle = '#718096';
                this.ctx.fillText('Aligning your investments with your needs', 50, 90);
                
                // Y-axis
                this.ctx.strokeStyle = '#e2e8f0';
                this.ctx.lineWidth = 2;
                this.ctx.beginPath();
                this.ctx.moveTo(120, 150);
                this.ctx.lineTo(120, h - 100);
                this.ctx.stroke();
                
                // X-axis
                this.ctx.beginPath();
                this.ctx.moveTo(120, h - 100);
                this.ctx.lineTo(w - 100, h - 100);
                this.ctx.stroke();
                
                // Axis labels
                this.ctx.save();
                this.ctx.translate(40, (h - 100 + 150) / 2);
                this.ctx.rotate(-Math.PI / 2);
                this.ctx.fillStyle = '#e53e3e';
                this.ctx.font = '16px Arial';
                this.ctx.fillText('Return / Volatility', -60, 0);
                this.ctx.restore();
                
                this.ctx.fillStyle = '#e53e3e';
                this.ctx.fillText('Time (Years)', w - 200, h - 70);
                
                // Investment categories with circles
                const categories = [
                    {x: 200, y: h - 180, label: 'LIQUID', icon: '💧', color: '#4299e1'},
                    {x: 350, y: h - 250, label: 'STABLE', icon: '🏛️', color: '#38b2ac'},
                    {x: 500, y: h - 320, label: 'BALANCED', icon: '⚖️', color: '#805ad5'},
                    {x: 650, y: h - 380, label: 'GROWTH', icon: '🌱', color: '#38a169'},
                    {x: 800, y: h - 180, label: 'INTERGEN', icon: '👥', color: '#718096'}
                ];
                
                categories.forEach(cat => {
                    // Circle
                    this.ctx.beginPath();
                    this.ctx.arc(cat.x, cat.y, 40, 0, 2 * Math.PI);
                    this.ctx.strokeStyle = cat.color;
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    // Icon (simplified)
                    this.ctx.fillStyle = cat.color;
                    this.ctx.font = '20px Arial';
                    this.ctx.fillText(cat.icon, cat.x - 10, cat.y + 5);
                    
                    // Label
                    this.ctx.font = 'bold 14px Arial';
                    this.ctx.fillText(cat.label, cat.x - 25, cat.y + 65);
                });
                
                // Timeline markers
                const timeMarkers = [2, 5, 10];
                timeMarkers.forEach(year => {
                    const x = 120 + (year / 12) * (w - 220);
                    this.ctx.strokeStyle = '#cbd5e0';
                    this.ctx.lineWidth = 1;
                    this.ctx.setLineDash([5, 5]);
                    this.ctx.beginPath();
                    this.ctx.moveTo(x, 150);
                    this.ctx.lineTo(x, h - 100);
                    this.ctx.stroke();
                    this.ctx.setLineDash([]);
                    
                    this.ctx.fillStyle = '#4a5568';
                    this.ctx.font = '14px Arial';
                    this.ctx.fillText(year.toString(), x - 5, h - 75);
                });
                
                // Example goals
                this.ctx.fillStyle = '#38a169';
                this.ctx.font = '12px Arial';
                this.ctx.fillText('e.g. cash flow, living', 150, h - 150);
                this.ctx.fillText('expenses, holidays', 150, h - 135);
                
                this.ctx.fillText('e.g. renovation in', 300, h - 200);
                this.ctx.fillText('four years time', 300, h - 185);
                
                this.ctx.fillText('e.g. help the kids', 450, h - 270);
                this.ctx.fillText('with a house deposit', 450, h - 255);
                this.ctx.fillText('in six years time', 450, h - 240);
                
                this.ctx.fillText('e.g. retire at the', 600, h - 330);
                this.ctx.fillText('age of 62', 600, h - 315);
                
                this.ctx.fillText('e.g. funding the', 750, h - 150);
                this.ctx.fillText("grandchildren's", 750, h - 135);
                this.ctx.fillText('education', 750, h - 120);
                
                // Entity types box
                this.ctx.strokeStyle = '#a0aec0';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(50, 150, 150, 180);
                
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 14px Arial';
                this.ctx.fillText('Entities', 120, 170);
                
                const entities = ['Personal', 'Super', 'Super Pensions', 'Insurance Bond', 'Family Trust', 'Company'];
                entities.forEach((entity, i) => {
                    this.ctx.font = '12px Arial';
                    this.ctx.fillText(entity, 60, 190 + i * 20);
                });
            }

            drawPortfolioTemplate() {
                const w = this.canvas.width / this.zoom;
                const h = this.canvas.height / this.zoom;
                const centerX = w / 2;
                const centerY = h / 2;
                const radius = Math.min(w, h) * 0.25;
                
                // Title
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 28px Arial';
                this.ctx.fillText('PORTFOLIO ALLOCATION', centerX - 150, 60);
                
                // Pie chart sectors
                const allocations = [
                    {label: 'Stocks', percent: 60, color: '#4299e1'},
                    {label: 'Bonds', percent: 25, color: '#38a169'},
                    {label: 'Real Estate', percent: 10, color: '#ed8936'},
                    {label: 'Cash', percent: 5, color: '#805ad5'}
                ];
                
                let currentAngle = -Math.PI / 2;
                
                allocations.forEach(allocation => {
                    const sliceAngle = (allocation.percent / 100) * 2 * Math.PI;
                    
                    // Draw slice
                    this.ctx.beginPath();
                    this.ctx.moveTo(centerX, centerY);
                    this.ctx.arc(centerX, centerY, radius, currentAngle, currentAngle + sliceAngle);
                    this.ctx.closePath();
                    this.ctx.fillStyle = allocation.color;
                    this.ctx.fill();
                    this.ctx.strokeStyle = 'white';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                    
                    // Label
                    const labelAngle = currentAngle + sliceAngle / 2;
                    const labelX = centerX + Math.cos(labelAngle) * (radius + 50);
                    const labelY = centerY + Math.sin(labelAngle) * (radius + 50);
                    
                    this.ctx.fillStyle = '#4a5568';
                    this.ctx.font = 'bold 14px Arial';
                    this.ctx.fillText(`${allocation.label}`, labelX - 30, labelY);
                    this.ctx.fillText(`${allocation.percent}%`, labelX - 15, labelY + 20);
                    
                    currentAngle += sliceAngle;
                });
            }

            drawCashFlowTemplate() {
                const w = this.canvas.width / this.zoom;
                const h = this.canvas.height / this.zoom;
                
                // Title
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 28px Arial';
                this.ctx.fillText('MONTHLY CASH FLOW ANALYSIS', 50, 60);
                
                // Income section
                this.ctx.fillStyle = '#38a169';
                this.ctx.font = 'bold 20px Arial';
                this.ctx.fillText('INCOME', 100, 120);
                
                const incomeItems = ['Salary', 'Investment Returns', 'Other Income'];
                incomeItems.forEach((item, i) => {
                    this.ctx.fillStyle = '#4a5568';
                    this.ctx.font = '16px Arial';
                    this.ctx.fillText(`${item}: $______`, 100, 150 + i * 30);
                });
                
                // Expenses section
                this.ctx.fillStyle = '#e53e3e';
                this.ctx.font = 'bold 20px Arial';
                this.ctx.fillText('EXPENSES', 100, 280);
                
                const expenseItems = ['Housing', 'Transportation', 'Food', 'Insurance', 'Utilities', 'Entertainment', 'Savings'];
                expenseItems.forEach((item, i) => {
                    this.ctx.fillStyle = '#4a5568';
                    this.ctx.font = '16px Arial';
                    this.ctx.fillText(`${item}: $______`, 100, 310 + i * 30);
                });
                
                // Net cash flow
                this.ctx.strokeStyle = '#4a5568';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(100, h - 150, 300, 80);
                
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 18px Arial';
                this.ctx.fillText('NET CASH FLOW: $______', 120, h - 110);
            }

            drawRetirementTemplate() {
                const w = this.canvas.width / this.zoom;
                const h = this.canvas.height / this.zoom;
                
                // Title
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 28px Arial';
                this.ctx.fillText('RETIREMENT PLANNING TIMELINE', 50, 60);
                
                // Timeline
                this.ctx.strokeStyle = '#4299e1';
                this.ctx.lineWidth = 4;
                this.ctx.beginPath();
                this.ctx.moveTo(100, h/2);
                this.ctx.lineTo(w - 100, h/2);
                this.ctx.stroke();
                
                // Age markers
                const ages = [30, 40, 50, 60, 65, 70];
                ages.forEach((age, i) => {
                    const x = 100 + (i * (w - 200) / (ages.length - 1));
                    
                    // Marker circle
                    this.ctx.beginPath();
                    this.ctx.arc(x, h/2, 8, 0, 2 * Math.PI);
                    this.ctx.fillStyle = '#4299e1';
                    this.ctx.fill();
                    
                    // Age label
                    this.ctx.fillStyle = '#4a5568';
                    this.ctx.font = 'bold 14px Arial';
                    this.ctx.fillText(age.toString(), x - 10, h/2 + 30);
                    
                    // Milestone
                    if (age === 40) this.ctx.fillText('Max 401k', x - 25, h/2 - 20);
                    if (age === 50) this.ctx.fillText('Catch-up', x - 25, h/2 - 20);
                    if (age === 65) this.ctx.fillText('Retirement', x - 30, h/2 - 20);
                });
            }

            drawDebtTemplate() {
                const w = this.canvas.width / this.zoom;
                const h = this.canvas.height / this.zoom;
                
                // Title
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 28px Arial';
                this.ctx.fillText('DEBT PAYOFF STRATEGY', 50, 60);
                
                // Two columns
                this.ctx.strokeStyle = '#e2e8f0';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(50, 100, w/2 - 100, h - 200);
                this.ctx.strokeRect(w/2 + 50, 100, w/2 - 100, h - 200);
                
                // Column headers
                this.ctx.fillStyle = '#e53e3e';
                this.ctx.font = 'bold 20px Arial';
                this.ctx.fillText('DEBT SNOWBALL', 70, 130);
                this.ctx.fillText('DEBT AVALANCHE', w/2 + 70, 130);
                
                // Debt items
                const debts = ['Credit Card 1', 'Credit Card 2', 'Car Loan', 'Student Loan'];
                debts.forEach((debt, i) => {
                    this.ctx.fillStyle = '#4a5568';
                    this.ctx.font = '14px Arial';
                    this.ctx.fillText(`${debt}: $____`, 70, 160 + i * 30);
                    this.ctx.fillText(`${debt}: $____`, w/2 + 70, 160 + i * 30);
                });
            }

            drawEmergencyTemplate() {
                const w = this.canvas.width / this.zoom;
                const h = this.canvas.height / this.zoom;
                
                // Title
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 28px Arial';
                this.ctx.fillText('EMERGENCY FUND PLANNING', 50, 60);
                
                // Monthly expenses box
                this.ctx.strokeStyle = '#4299e1';
                this.ctx.lineWidth = 2;
                this.ctx.strokeRect(100, 120, 300, 200);
                
                this.ctx.fillStyle = '#4299e1';
                this.ctx.font = 'bold 18px Arial';
                this.ctx.fillText('MONTHLY EXPENSES', 120, 145);
                
                const expenses = ['Housing', 'Food', 'Transportation', 'Utilities', 'Insurance'];
                expenses.forEach((expense, i) => {
                    this.ctx.fillStyle = '#4a5568';
                    this.ctx.font = '14px Arial';
                    this.ctx.fillText(`${expense}: $____`, 120, 170 + i * 25);
                });
                
                // Target amounts
                this.ctx.fillStyle = '#38a169';
                this.ctx.font = 'bold 18px Arial';
                this.ctx.fillText('TARGET EMERGENCY FUND', 120, 380);
                this.ctx.fillText('3 Months: $____', 120, 410);
                this.ctx.fillText('6 Months: $____', 120, 440);
            }

            drawComparisonTemplate() {
                const w = this.canvas.width / this.zoom;
                const h = this.canvas.height / this.zoom;
                
                // Title
                this.ctx.fillStyle = '#4a5568';
                this.ctx.font = 'bold 28px Arial';
                this.ctx.fillText('INVESTMENT COMPARISON', 50, 60);
                
                // Comparison table
                const cols = 3;
                const rows = 6;
                const cellWidth = (w - 200) / cols;
                const cellHeight = 50;
                const startX = 100;
                const startY = 120;
                
                // Headers
                const headers = ['Criteria', 'Option A', 'Option B'];
                headers.forEach((header, i) => {
                    this.ctx.fillStyle = '#4299e1';
                    this.ctx.fillRect(startX + i * cellWidth, startY, cellWidth, cellHeight);
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = 'bold 16px Arial';
                    this.ctx.fillText(header, startX + i * cellWidth + 20, startY + 30);
                });
                
                // Criteria rows
                const criteria = ['Expected Return', 'Risk Level', 'Liquidity', 'Fees', 'Tax Efficiency'];
                criteria.forEach((criterion, i) => {
                    for (let j = 0; j < cols; j++) {
                        this.ctx.strokeStyle = '#e2e8f0';
                        this.ctx.lineWidth = 1;
                        this.ctx.strokeRect(startX + j * cellWidth, startY + (i + 1) * cellHeight, cellWidth, cellHeight);
                        
                        if (j === 0) {
                            this.ctx.fillStyle = '#4a5568';
                            this.ctx.font = '14px Arial';
                            this.ctx.fillText(criterion, startX + 20, startY + (i + 1) * cellHeight + 30);
                        }
                    }
                });
            }

            applySelectedBackground() {
                const selected = document.querySelector('.background-option.selected');
                if (selected) {
                    this.selectedBackground = selected.dataset.bg;
                    this.showGrid = this.selectedBackground === 'blank';
                    this.redraw();
                }
            }

            saveState() {
                // In a real implementation, save drawing state for undo/redo
            }

            undo() {
                // In a real implementation, restore previous state
                console.log('Undo functionality would restore previous state');
            }

            setupCollaboration() {
                // Simulate real-time collaboration
                this.myId = 'user_' + Math.random().toString(36).substr(2, 9);
                this.updateParticipantCount();
            }

            simulateCollaboration() {
                // Add some simulated participants for demo
                setTimeout(() => {
                    this.addParticipant('user_sarah', '#ff6b6b');
                    this.addParticipant('user_mike', '#4ecdc4');
                }, 2000);

                // Simulate cursor movement
                setInterval(() => {
                    this.updateRandomCursor();
                }, 3000);
            }

            addParticipant(id, color) {
                this.participants.set(id, {
                    color: color,
                    cursor: this.createCursorIndicator(color, id)
                });
                this.updateParticipantCount();
            }

            createCursorIndicator(color, id) {
                const cursor = document.createElement('div');
                cursor.className = 'cursor-indicator';
                cursor.style.background = color;
                cursor.style.opacity = '0.8';
                
                const label = document.createElement('div');
                label.className = 'participant-label';
                label.textContent = id.replace('user_', '').charAt(0).toUpperCase() + id.replace('user_', '').slice(1);
                cursor.appendChild(label);
                
                document.querySelector('.canvas-container').appendChild(cursor);
                return cursor;
            }

            updateRandomCursor() {
                this.participants.forEach((participant, id) => {
                    if (Math.random() > 0.7) {
                        const x = Math.random() * this.canvas.width;
                        const y = Math.random() * this.canvas.height;
                        participant.cursor.style.left = x + 'px';
                        participant.cursor.style.top = y + 'px';
                        participant.cursor.style.opacity = '0.8';
                        
                        setTimeout(() => {
                            participant.cursor.style.opacity = '0.3';
                        }, 1000);
                    }
                });
            }

            updateCursor(e) {
                // In a real implementation, broadcast cursor position to other users
            }

            updateParticipantCount() {
                document.getElementById('participantCount').textContent = this.participants.size + 1;
            }

            zoomIn() {
                this.zoom = Math.min(this.zoom * 1.2, 5);
                this.redraw();
            }

            zoomOut() {
                this.zoom = Math.max(this.zoom / 1.2, 0.2);
                this.redraw();
            }

            resetZoom() {
                this.zoom = 1;
                this.panX = 0;
                this.panY = 0;
                this.redraw();
            }

            toggleGrid() {
                this.showGrid = !this.showGrid;
                this.redraw();
            }

            clear() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                this.textInputs.forEach(input => input.input.remove());
                this.textInputs = [];
                if (this.showGrid) this.drawGrid();
            }

            save() {
                const link = document.createElement('a');
                link.download = `financial-planning-${new Date().toISOString().split('T')[0]}.png`;
                link.href = this.canvas.toDataURL();
                link.click();
                
                const indicator = document.getElementById('saveIndicator');
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            }

            async copyToClipboard() {
                try {
                    // Convert canvas to blob
                    const canvas = this.canvas;
                    
                    return new Promise((resolve, reject) => {
                        canvas.toBlob(async (blob) => {
                            try {
                                // Create clipboard item
                                const clipboardItem = new ClipboardItem({
                                    'image/png': blob
                                });
                                
                                // Write to clipboard
                                await navigator.clipboard.write([clipboardItem]);
                                
                                // Show success indicator
                                this.showCopyIndicator('Copied to clipboard!');
                                resolve();
                            } catch (error) {
                                // Fallback: copy as data URL to clipboard as text
                                const dataURL = canvas.toDataURL();
                                await navigator.clipboard.writeText(dataURL);
                                this.showCopyIndicator('Image data copied as text!');
                                resolve();
                            }
                        }, 'image/png');
                    });
                } catch (error) {
                    console.error('Copy failed:', error);
                    this.showCopyIndicator('Copy failed - try Save instead', true);
                }
            }

            showCopyIndicator(message, isError = false) {
                const indicator = document.getElementById('saveIndicator');
                indicator.textContent = message;
                indicator.style.background = isError ? 'rgba(239, 68, 68, 0.9)' : 'rgba(34, 197, 94, 0.9)';
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                    indicator.textContent = 'Whiteboard Saved!';
                    indicator.style.background = 'rgba(0,0,0,0.8)';
                }, 2500);
            }
        }

        // Initialize the whiteboard first
        let whiteboard;
        
        // Global functions for toolbar buttons
        function clearCanvas() {
            if (whiteboard) whiteboard.clear();
        }

        function saveCanvas() {
            if (whiteboard) whiteboard.save();
        }

        function copyCanvas() {
            if (whiteboard) whiteboard.copyToClipboard();
        }

        function toggleGrid() {
            if (whiteboard) whiteboard.toggleGrid();
        }

        function zoomIn() {
            if (whiteboard) whiteboard.zoomIn();
        }

        function zoomOut() {
            if (whiteboard) whiteboard.zoomOut();
        }

        function resetZoom() {
            if (whiteboard) whiteboard.resetZoom();
        }

        function showBackgrounds() {
            document.getElementById('backgroundSelector').classList.add('show');
        }

        function hideBackgrounds() {
            document.getElementById('backgroundSelector').classList.remove('show');
            // Clear any selections
            document.querySelectorAll('.background-option.selected').forEach(opt => {
                opt.classList.remove('selected');
            });
            // Disable apply button
            document.getElementById('applyBackgroundBtn').disabled = true;
        }

        function applyBackground() {
            if (whiteboard) {
                whiteboard.applySelectedBackground();
                hideBackgrounds();
            }
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Create the whiteboard
            whiteboard = new CollaborativeWhiteboard();
            
            // Set up background selection handling
            document.querySelectorAll('.background-option').forEach(option => {
                option.addEventListener('click', function() {
                    // Remove previous selection
                    document.querySelectorAll('.background-option.selected').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    // Add selection to clicked option
                    this.classList.add('selected');
                    
                    // Enable apply button
                    document.getElementById('applyBackgroundBtn').disabled = false;
                });
            });
        });

        // Add some helpful shortcuts info
        console.log('Keyboard shortcuts:');
        console.log('Ctrl/Cmd + Z: Undo');
        console.log('Ctrl/Cmd + S: Save');
        console.log('Ctrl/Cmd + C: Copy to clipboard');
        console.log('Escape: Cancel text input');
    </script>
</body>
</html>
